<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ポーズ・マスター 60 Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: 'Arial Black', 'Hiragino Kaku Gothic Pro', sans-serif;
        }

        .container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        video { display: none; }
        canvas {
            width: 100vw;
            height: 100vh;
            object-fit: cover; 
            transform: scaleX(-1);
        }

        /* UI表示 */
        .ui-header {
            position: absolute;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 10;
            pointer-events: none;
        }

        .info-box {
            background: rgba(0,0,0,0.7);
            padding: 10px 25px;
            border-radius: 15px;
            font-size: 28px;
            border: 2px solid;
        }
        #score-display { color: #00ffcc; border-color: #00ffcc; }
        #timer-display { color: #ff3366; border-color: #ff3366; }

        /* 中央コマンド */
        #command-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
            pointer-events: none;
            z-index: 5;
        }
        #command-text {
            font-size: clamp(80px, 15vw, 160px);
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 20px rgba(0,0,0,1), 0 0 40px #ff00ff;
        }

        /* オーバーレイ画面 */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            text-align: center;
        }

        .btn-start {
            padding: 25px 60px;
            font-size: 28px;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 60px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(255,0,0,0.5);
        }

        .guide-text {
            margin-top: 30px;
            font-size: 18px;
            line-height: 1.8;
            color: #ddd;
        }
        .highlight { color: #00ffcc; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <video id="input_video" playsinline></video>
        <canvas id="output_canvas"></canvas>

        <div class="ui-header">
            <div id="score-display" class="info-box">SCORE: <span id="val-score">0</span></div>
            <div id="timer-display" class="info-box">TIME: <span id="val-timer">60</span></div>
        </div>

        <div id="command-container">
            <div id="command-text">READY?</div>
        </div>

        <div id="start-screen" class="overlay">
            <h1>ポーズ・マスター 60</h1>
            <button class="btn-start" onclick="initApp()">カメラを起動する</button>
            <div class="guide-text">
                全身をカメラに映してください。<br>
                <span class="highlight">【開始ポーズ】</span><br>
                <b>両手をあげてスクワット</b>をするとスタート！
            </div>
        </div>

        <div id="result-screen" class="overlay" style="display: none;">
            <h1 style="font-size: 60px; color: #ffcc00;">TIME UP!</h1>
            <div style="font-size: 40px; margin: 20px;">SCORE: <span id="final-score">0</span></div>
            <div class="guide-text" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;">
                <span class="highlight">もう一度あそぶには？</span><br>
                再び <b>「両手をあげてスクワット」</b> をしてください。
            </div>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        
        const commands = ["両手", "左手", "右手", "両足", "左足", "右足"];
        let currentTarget = "";
        let score = 0;
        let timeLeft = 60;
        let gameActive = false;
        let timerInterval = null;
        let appInitialized = false;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const synth = window.speechSynthesis;

        function playSound(freq, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            osc.stop(audioCtx.currentTime + duration);
        }

        function speak(text) {
            synth.cancel();
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP';
            uttr.rate = 1.8;
            synth.speak(uttr);
        }

        function nextCommand() {
            const oldTarget = currentTarget;
            while (currentTarget === oldTarget) {
                currentTarget = commands[Math.floor(Math.random() * commands.length)];
            }
            document.getElementById('command-text').innerText = currentTarget;
            speak(currentTarget);
        }

        function startGame() {
            if (gameActive) return;
            
            // 状態リセット
            gameActive = true;
            score = 0;
            timeLeft = 60;
            
            // UIリセット
            document.getElementById('val-score').innerText = score;
            document.getElementById('val-timer').innerText = timeLeft;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            
            playSound(880, 0.5);
            speak("スタート！");
            nextCommand();

            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('val-timer').innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);
            document.getElementById('result-screen').style.display = 'flex';
            document.getElementById('final-score').innerText = score;
            document.getElementById('command-text').innerText = "FINISH!";
            speak("終了！スコアは" + score + "点です");
        }

        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        function onResults(results) {
            canvasElement.width = results.image.width;
            canvasElement.height = results.image.height;
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#ffffff', lineWidth: 2});
                drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#ff3366', radius: 3});

                const lm = results.poseLandmarks;
                const nose = lm[0], lWrist = lm[15], rWrist = lm[16];
                const lAnkle = lm[27], rAnkle = lm[28], lKnee = lm[25], rKnee = lm[26], lHip = lm[23], rHip = lm[24];

                // --- 判定ロジック ---
                const lHandUp = lWrist.y < nose.y;
                const rHandUp = rWrist.y < nose.y;
                const lAngle = calculateAngle(lHip, lKnee, lAnkle);
                const rAngle = calculateAngle(rHip, rKnee, rAnkle);
                const ankleDiff = lAnkle.y - rAnkle.y; 

                const THRESH_DOWN = 145; // 膝を曲げた判定
                const LIFT_GAP = 0.05;   // 足が浮いた判定の閾値

                const isBothHandsUp = lHandUp && rHandUp;
                const isLHandOnly = lHandUp && !rHandUp;
                const isRHandOnly = !lHandUp && rHandUp;
                const isSquat = lAngle < THRESH_DOWN && rAngle < THRESH_DOWN && Math.abs(ankleDiff) < LIFT_GAP;
                const isLFootUp = ankleDiff < -LIFT_GAP && lAngle < THRESH_DOWN;
                const isRFootUp = ankleDiff > LIFT_GAP && rAngle < THRESH_DOWN;

                // --- ゲーム開始・再開判定 ---
                // ゲームが動いていない時に「両手＋スクワット」を検知
                if (!gameActive && isBothHandsUp && isSquat) {
                    // 少しディレイを置かないと終了直後に誤爆するため、タイマーが60（初期）か終了画面の時のみ
                    startGame();
                }

                // --- プレイ中のターゲット判定 ---
                if (gameActive) {
                    let isCorrect = false;
                    switch(currentTarget) {
                        case "両手": if(isBothHandsUp) isCorrect = true; break;
                        case "左手": if(isLHandOnly) isCorrect = true; break;
                        case "右手": if(isRHandOnly) isCorrect = true; break;
                        case "両足": if(isSquat) isCorrect = true; break;
                        case "左足": if(isLFootUp) isCorrect = true; break;
                        case "右足": if(isRFootUp) isCorrect = true; break;
                    }

                    if (isCorrect) {
                        score++;
                        document.getElementById('val-score').innerText = score;
                        playSound(1200, 0.1);
                        nextCommand();
                    }
                }
            }
            canvasCtx.restore();
        }

        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
        });

        pose.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 1280, height: 720
        });

        function initApp() {
            if (appInitialized) return;
            audioCtx.resume();
            appInitialized = true;
            
            // UI表示の変更
            const startBtn = document.querySelector('.btn-start');
            startBtn.style.display = 'none';
            document.querySelector('.guide-text').innerHTML = "カメラを準備しています...<br><span style='font-size:24px; color:#ff3366;'>全身が映るまで下がってください！</span>";
            
            camera.start().then(() => {
                document.querySelector('.guide-text').innerHTML = "準備完了！<br><b style='font-size:30px; color:#00ffcc;'>「両手をあげてスクワット」</b><br>でゲーム開始！";
            });
        }
    </script>
</body>
</html>