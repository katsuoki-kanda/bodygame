<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ポーズ・マスター 60</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif;
        }

        .container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video { display: none; }
        canvas {
            width: 100vw;
            height: 100vh;
            object-fit: cover; 
            transform: scaleX(-1);
        }

        /* UI要素 */
        .ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .score-box {
            position: absolute;
            top: 20px; left: 20px;
            background: rgba(0,0,0,0.6);
            color: #00ffcc;
            padding: 10px 30px;
            border-radius: 15px;
            font-size: 24px;
            border: 2px solid #00ffcc;
        }

        .timer-box {
            position: absolute;
            top: 20px; right: 20px;
            background: rgba(0,0,0,0.6);
            color: #ff3366;
            padding: 10px 30px;
            border-radius: 15px;
            font-size: 24px;
            border: 2px solid #ff3366;
        }

        /* ターゲット指示 */
        #command-display {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 30px rgba(0,0,0,0.8), 0 0 10px #ff00ff;
            text-align: center;
            width: 100%;
        }

        #start-screen, #result-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            text-align: center;
            pointer-events: auto;
        }

        button {
            padding: 20px 50px;
            font-size: 24px;
            background: #00ffcc;
            color: #000;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        .instruction {
            font-size: 18px;
            line-height: 1.8;
            margin: 20px;
            color: #ccc;
        }

        .highlight { color: #ff3366; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <video id="input_video" playsinline></video>
        <canvas id="output_canvas"></canvas>

        <div class="ui-layer">
            <div class="score-box">SCORE: <span id="val-score">0</span></div>
            <div class="timer-box">TIME: <span id="val-timer">60</span>s</div>
            <div id="command-display">READY?</div>
        </div>

        <div id="start-screen">
            <h1>ポーズ・マスター 60</h1>
            <div class="instruction">
                指示されたポーズを素早く行え！<br>
                1アクションにつき1点獲得。<br><br>
                <span class="highlight">【ゲーム開始方法】</span><br>
                カメラに全身を映し、<br>
                <b>「両手をあげた状態でスクワット」</b>をしてください。
            </div>
            <button onclick="initApp()">カメラ起動</button>
        </div>

        <div id="result-screen" style="display: none;">
            <h1>TIME UP!</h1>
            <div style="font-size: 48px; margin: 20px;">SCORE: <span id="final-score">0</span></div>
            <button onclick="resetGame()">もう一度挑戦</button>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        
        const commands = ["両手", "左手", "右手", "両足", "左足", "右足"];
        let currentTarget = "";
        let score = 0;
        let timeLeft = 60;
        let gameActive = false;
        let timerInterval = null;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const synth = window.speechSynthesis;

        function playSound(freq, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            osc.stop(audioCtx.currentTime + duration);
        }

        function speak(text) {
            synth.cancel();
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP';
            uttr.rate = 1.5;
            synth.speak(uttr);
        }

        function nextCommand() {
            const oldTarget = currentTarget;
            // 同じ指示が続かないようにする
            do {
                currentTarget = commands[Math.floor(Math.random() * commands.length)];
            } while (currentTarget === oldTarget);
            
            document.getElementById('command-display').innerText = currentTarget;
            speak(currentTarget);
        }

        function startGame() {
            if (gameActive) return;
            gameActive = true;
            score = 0;
            timeLeft = 60;
            document.getElementById('val-score').innerText = score;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            
            playSound(880, 0.5);
            nextCommand();

            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('val-timer').innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);
            document.getElementById('result-screen').style.display = 'flex';
            document.getElementById('final-score').innerText = score;
            document.getElementById('command-display').innerText = "FINISH!";
            speak("終了！スコアは" + score + "点です");
        }

        function resetGame() {
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('command-display').innerText = "READY?";
        }

        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        }

        function onResults(results) {
            canvasElement.width = results.image.width;
            canvasElement.height = results.image.height;
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00ffcc', lineWidth: 2});
                drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#ff3366', radius: 3});

                const lm = results.poseLandmarks;
                const nose = lm[0], lWrist = lm[15], rWrist = lm[16];
                const lAnkle = lm[27], rAnkle = lm[28], lKnee = lm[25], rKnee = lm[26], lHip = lm[23], rHip = lm[24];

                const lHandUp = lWrist.y < nose.y;
                const rHandUp = rWrist.y < nose.y;
                const lAngle = calculateAngle(lHip, lKnee, lAnkle);
                const rAngle = calculateAngle(rHip, rKnee, rAnkle);
                const ankleDiff = lAnkle.y - rAnkle.y; 

                const THRESH_DOWN = 140;
                const LIFT_GAP = 0.05;

                // ポーズ判定
                let detectedPose = "";
                
                // 1. 足の判定
                const isSquat = lAngle < THRESH_DOWN && rAngle < THRESH_DOWN && Math.abs(ankleDiff) < LIFT_GAP;
                const isLFootUp = ankleDiff < -LIFT_GAP && lAngle < THRESH_DOWN;
                const isRFootUp = ankleDiff > LIFT_GAP && rAngle < THRESH_DOWN;

                // 2. 手の判定
                const isBothHandsUp = lHandUp && rHandUp;
                const isLHandUpOnly = lHandUp && !rHandUp;
                const isRHandUpOnly = !lHandUp && rHandUp;

                // 開始判定：両手アップ ＋ スクワット
                if (!gameActive && isBothHandsUp && isSquat && timeLeft === 60) {
                    startGame();
                }

                if (gameActive) {
                    let success = false;
                    switch(currentTarget) {
                        case "両手": if(isBothHandsUp) success = true; break;
                        case "左手": if(isLHandUpOnly) success = true; break;
                        case "右手": if(isRHandUpOnly) success = true; break;
                        case "両足": if(isSquat) success = true; break;
                        case "左足": if(isLFootUp) success = true; break;
                        case "右足": if(isRFootUp) success = true; break;
                    }

                    if (success) {
                        score++;
                        document.getElementById('val-score').innerText = score;
                        playSound(1200, 0.1);
                        nextCommand();
                    }
                }
            }
            canvasCtx.restore();
        }

        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
        });

        pose.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 1280, height: 720
        });

        function initApp() {
            audioCtx.resume();
            document.getElementById('start-screen').querySelector('button').style.display = 'none';
            document.getElementById('start-screen').querySelector('.instruction').innerText = "カメラ起動中... 全身を映して開始ポーズをとってください！";
            camera.start();
        }
    </script>
</body>
</html>